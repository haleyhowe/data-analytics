---
title: "cgm_Tidepool_Summer"
output: html_document
---
```{r}
library("readxl")
library(ggrepel)
library(ggplot2)
library(dplyr)
library(caret)
library(class)
library(caTools)
library(chron)
library(viridis)
library(scales)
library(grid)
library(lubridate)
```

```{r}
setwd("~/Desktop/HS650")
cgm = read_excel('Data_1.xlsx', sheet = 2) 
smbg = read_excel('Data_1.xlsx', sheet = 1)
basal = read_excel('Data_1.xlsx', sheet = 6)
bolus = read_excel('Data_1.xlsx', sheet = 4)

```
```{r}

#Changing the column names to readable in R
#CGM
colnames(cgm)[7] <- "Local_Time"
#Basal
colnames(basal)[14] <- "Local_Time"
colnames(basal)[4] <- "Delivery_Type"
#Bolus
colnames(bolus)[12] <- "Local_Time"
#Smbg
colnames(smbg)[8] <- "Local_Time"


```
```{r}
```{r}
#Connverting Basal times to UTC format 
basal$Local_Time <- as.numeric(as.character(basal$Local_Time)) 
basal$Local_Time <- as.POSIXct(basal$Local_Time*3600*24, origin=as.Date("1900-01-01")-2, tz="UTC")
basal$Local_Time
```

```{r}
# This function returns a new dataframe with the specific column and value the user wishes to subset by

#' @param dataset the dataframe to be used
#' @param column_name string, the name of the column to be separated by
#' @param x string, the specific type to be separated by within that column
#'
#' @return a new dataframe subsetted by the particular column the user requests
#' @examples CBG = device_type(new_tidepool, 'type', "cbg")

device_type <- function(dataset,column_name, x){
  col_1 = dataset[column_name]
  new_subset <- subset(dataset,  col_1 == x)
  return(new_subset)
}
```

```{r}
#' This is a function to subset the data by day, month, and device type specified by the user
#'
#' @param xday --> integer, the day the user wishes to access
#' @param xmonth --> string, the month the user wishes to access
#' @param dtype --> dataframe, the datefram used to be coerced 
#'
#' @return a subsetted selection of that month and day by device type
#' @examples myday_month(4,"September", SMBG)

myday_month <- function(xday, xmonth, dtype){
  new_subset <- subset(dtype, ((day(dtype$Local_Time) == xday & months(dtype$Local_Time)==xmonth)))
  if ((dim(new_subset)[1]) ==0){
    print("There is no data for this month and day.")
  }
  return(new_subset)
}


```

```{r}
#September 4 Example 

#Smbg
s_September_4 <- myday_month(4,"September", smbg)

#Cgm
c_September_4 <- myday_month(4,"September", cgm)

#Creating a column to distinguish high/low alerts
c_September_4$High_low <- NA
c_September_4$High_low[c_September_4$Value >= 180] <- "High"
c_September_4$High_low[c_September_4$Value <= 70] <- "Low"
c_September_4$High_low[c_September_4$Value <= 180 & c_September_4$Value >= 70] <- "Normal"
c_September_4$High_low <- as.factor(c_September_4$High_low)

#Basal- subsetting by "temp" delivery
temp_deliv <- device_type(basal, 'Delivery_Type', "temp")

#September 4 Temp Basal Rates 
temp_Sept4 <- myday_month(4,"September", temp_deliv)

#Bolus
bolus_Sept4 <- myday_month(4,"September", bolus)

```


```{r}

#' Temp Rates and SMBG
#' This function will count the number of times the user changed their setting to 'temp' delivery and checked their finger stick value within 60 min (time limit can be adjusted)
#' @return count of number of times user checked fingerstick within amount of time after setting 'temp' delivery
#' @examples
#' temp_smbg()

temp_smbg <- function(){
count = 0
for (i in 1:nrow(s_September_4)){
  for (x in 1:nrow(temp_Sept4)){
    if(s_September_4$Local_Time[i] > temp_Sept4$Local_Time[x]){
      if((s_September_4$Local_Time[i]- temp_Sept4$Local_Time[x]) < dminutes(60)){
        count = count + 1
        print(s_September_4$Local_Time[i] -(temp_Sept4$Local_Time[x]))
        print(paste("Basal Temp setting time :", temp_Sept4$Local_Time[x]))
        print(paste("Fingerstick input Time: ", s_September_4$Local_Time[i]))
        print(paste("Number of times user checked fingerstick within 60 min of setting of temp rate: " , count))
      }
    }
  }
}
}

temp_smbg()

```

```{r}
### High Glucose Alert Activity 

high_BG <- subset(c_September_4, (High_low == "High"))


#' High BG alert and SMBG
#' Amount of time between a high glucose alert and when the user checked glucose through fingerstick device.
#' @return The amount of time of an instances when the user has a high glucose alert and checked their fingerstick BG. Must be within 30 min to output time difference.
#' @examples high_smbg()

high_smbg <- function(){
count = 0
for (i in 1:nrow(s_September_4)){
  for (x in 1:nrow(high_BG)){
    if(s_September_4$Local_Time[i] > high_BG$Local_Time[x]){
      if((s_September_4$Local_Time[i]- high_BG$Local_Time[x]) < dminutes(30)){
        count = count + 1
        print(s_September_4$Local_Time[i] -(high_BG$Local_Time[x]))
        print(paste("High Glucose Alert Time:",high_BG$Local_Time[x]))
        print(paste("Fingerstick input Time:", s_September_4$Local_Time[i]))
      }
    }
  }
}
}

high_smbg()

```

```{r}
#' Frequency: High BG and SMBG (5 minutes)
#' @return prints out the fingerstick input time and the high glucose alert time if the user checked the two within 5 min of each other. also prints out the count of how many times this occured throughout the day 
#' @examples freq_smbg_5()

freq_smbg_5 <- function(){
count=0
for (i in 1:nrow(s_September_4)){
  for (x in 1:nrow(high_BG)){
    if(s_September_4$Local_Time[i] > high_BG$Local_Time[x]){
      if((s_September_4$Local_Time[i]- high_BG$Local_Time[x]) < dminutes(5)){
        count = count + 1
        print(s_September_4$Local_Time[i] -(high_BG$Local_Time[x]))
        print(paste("Fingerstick input Time:",s_September_4$Local_Time[i]))
        print(paste("High Glucose Alert Time:", high_BG$Local_Time[x]))
        print(paste("Frequency of BG Check entry within 5 min of high glucose alert: ",count))
      }
    }
  }
}
}

freq_smbg_5()
```

```{r}

#' High BG and Bolus
#' @return prints out the amount of time between when the user recieved a high BG alert and recieved a Bolus of insulin if this was within 60 min
#' @examples highBG_insulin

highBG_insulin <- function(){
count=0
for (i in 1:nrow(bolus_Sept4)){
  for (x in 1:nrow(high_BG)){
    if(bolus_Sept4$Local_Time[i] > high_BG$Local_Time[x]){
      if((bolus_Sept4$Local_Time[i]- high_BG$Local_Time[x]) < dminutes(60)){
        count = count + 1
        print(bolus_Sept4$Local_Time[i] -(high_BG$Local_Time[x]))
        print(paste("High Glucose Alert Time:", high_BG$Local_Time[x]))
        print(paste("Insulin Bolus Time:",bolus_Sept4$Local_Time[i]))
        print(" ")
  
      }
    }
  }
}
}

highBG_insulin()


```
```{r}

#' Frequency: High BG alert and Bolus
#' @return prints out Frequency of insulin bolus within 1 min of high BG alert
#' @examples bolus_high()

bolus_high <- function(){
count=0
for (i in 1:nrow(bolus_Sept4)){
  for (x in 1:nrow(high_BG)){
    if(bolus_Sept4$Local_Time[i] > high_BG$Local_Time[x]){
      if((bolus_Sept4$Local_Time[i]- high_BG$Local_Time[x]) < dminutes(1)){
        count = count + 1
        print(bolus_Sept4$Local_Time[i] -(high_BG$Local_Time[x]))
        print(paste("High Glucose Alert Time:", high_BG$Local_Time[x]))
        print(paste("Insulin Bolus Time:",bolus_Sept4$Local_Time[i]))
        print(" ")
      }

    }
  }
}
print(paste("Frequency of insulin bolus within *1 min* of high BG alert:", count))
}

bolus_high()
```

```{r}
### Low Glucose Alert Activity 
low_BG <- subset(c_September_4, (High_low == "Low"))
count <- 0

#1

#' Low BG Alert and SMBG
#' @return prints out the amount of time between the Low glucose alert and when they checked glucose through fingerstick device if these events were within 30 min of each other.
#' @examples low_smbg()

low_smbg <- function(){
for (i in 1:nrow(s_September_4)){
  for (x in 1:nrow(low_BG)){
    if(s_September_4$Local_Time[i] > low_BG$Local_Time[x]){
      if((s_September_4$Local_Time[i]- low_BG$Local_Time[x]) < dminutes(30)){
        count = count + 1
        print(s_September_4$Local_Time[i] -(low_BG$Local_Time[x]))
        print(paste("Low Glucose Alert Time:",low_BG$Local_Time[x]))
        print(paste("Fingerstick input Time:", s_September_4$Local_Time[i]))
      }
    }
  }
}
}

low_smbg()

```


```{r}
#' Frequency of Low BG alert and SMBG (5 minutes)
#' @return prints out the frequency of BG Check entry within 5 min of Low glucose alert 
#' @examples freq_smbgLow_5()

freq_smbgLow_5 <- function(){
count=0
for (i in 1:nrow(s_September_4)){
  for (x in 1:nrow(low_BG)){
    if(s_September_4$Local_Time[i] > low_BG$Local_Time[x]){
      if((s_September_4$Local_Time[i]- low_BG$Local_Time[x]) < dminutes(5)){
        count = count + 1
        print(s_September_4$Local_Time[i] -(low_BG$Local_Time[x]))
        print(paste("Fingerstick input Time:",s_September_4$Local_Time[i]))
        print(paste("Low Glucose Alert Time:", low_BG$Local_Time[x]))
      }
    }
  }
}
print(paste("Frequency of BG Check entry within *5 min* of Low glucose alert: ",count))
}

freq_smbgLow_5()
```

```{r}
#' Low BG and Bolus
#' @return prints out the length of time between Low BG alert and insulin bolus if these events occur within 60 min of each other
#' @examples lowBG_insulin()

lowBG_insulin <- function(){
count=0
for (i in 1:nrow(bolus_Sept4)){
  for (x in 1:nrow(low_BG)){
    if(bolus_Sept4$Local_Time[i] > low_BG$Local_Time[x]){
      if((bolus_Sept4$Local_Time[i]- low_BG$Local_Time[x]) < dminutes(60)){
        count = count + 1
        print(bolus_Sept4$Local_Time[i] -(low_BG$Local_Time[x]))
        print(paste("Low Glucose Alert Time:", low_BG$Local_Time[x]))
        print(paste("Insulin Bolus Time:",bolus_Sept4$Local_Time[i]))
        print(" ")
  
      }
    }
  }
}
}

lowBG_insulin()

```



```{r}

#' Frequency: Low BG and Bolus
#' @return prints out the frequency of insulin bolus within 1 min of Low BG alert
#' @examples bolus_low()

bolus_low <- function(){
count=0
for (i in 1:nrow(bolus_Sept4)){
  for (x in 1:nrow(low_BG)){
    if(bolus_Sept4$Local_Time[i] > low_BG$Local_Time[x]){
      if((bolus_Sept4$Local_Time[i]- low_BG$Local_Time[x]) < dminutes(1)){
        count = count + 1
        print(bolus_Sept4$Local_Time[i] -(low_BG$Local_Time[x]))
        print(paste("Low Glucose Alert Time:", low_BG$Local_Time[x]))
        print(paste("Insulin Bolus Time:",bolus_Sept4$Local_Time[i]))
        print(" ")
      }

    }
  }
}
print(paste("Frequency of insulin bolus within *1 min* of Low BG alert:", count))
}

bolus_low()
```


