---
 title: "shiny_Tidepool"
output: html_document
---
```{r}
library("readxl")
library(ggrepel)
library(ggplot2)
library(dplyr)
library(caret)
library(class)
library(caTools)
library(chron)
library(viridis)
library(scales)
library(grid)
library(lubridate)
```
```{r}
install.packages("rsconnect")
```

```{r}
setwd("~/Desktop/HS650")
cgm = read_excel('Data_1.xlsx', sheet = 2) 
smbg = read_excel('Data_1.xlsx', sheet = 1)
basal = read_excel('Data_1.xlsx', sheet = 6)
bolus = read_excel('Data_1.xlsx', sheet = 4)

```
```{r}

#Changing the column names to readable in R
#CGM
colnames(cgm)[7] <- "Local_Time"
#Basal
colnames(basal)[14] <- "Local_Time"
colnames(basal)[4] <- "Delivery_Type"
#Bolus
colnames(bolus)[12] <- "Local_Time"
#Smbg
colnames(smbg)[8] <- "Local_Time"


```

```{r}
#Connverting Basal times to UTC format 
basal$Local_Time <- as.numeric(as.character(basal$Local_Time)) 
basal$Local_Time <- as.POSIXct(basal$Local_Time*3600*24, origin=as.Date("1900-01-01")-2, tz="UTC")
basal$Local_Time
```

```{r}
device_type <- function(dataset,column_name, x){
  col_1 = dataset[column_name]
  new_subset <- subset(dataset,  col_1 == x)
  return(new_subset)
}
```

```{r}
myday_month <- function(xday, xmonth, dtype){
  new_subset <- subset(dtype, ((day(dtype$Local_Time) == xday & months(dtype$Local_Time)==xmonth)))
  if ((dim(new_subset)[1]) ==0){
    print("There is no data for this month and day.")
  }
  return(new_subset)
}
```
```{r}
high_low <- function(dataset){
  dataset$High_low <- NA
  dataset$High_low[dataset$Value >= 180] <- "High"
  dataset$High_low[dataset$Value <= 70] <- "Low"
  dataset$High_low[dataset$Value <= 180 & dataset$Value >= 70] <-   "Normal"
  dataset$High_low <- as.factor(dataset$High_low)
  
  return(dataset)
}

```



```{r}
#Smbg
s_September_4 <- myday_month(4,"September", smbg)


#Cgm
c_September_4 <- myday_month(4,"September", cgm)

#Creating a column to distinguish high/low alerts
c_September_4$High_low <- NA
c_September_4$High_low[c_September_4$Value >= 180] <- "High"
c_September_4$High_low[c_September_4$Value <= 70] <- "Low"
c_September_4$High_low[c_September_4$Value <= 180 & c_September_4$Value >= 70] <- "Normal"
c_September_4$High_low <- as.factor(c_September_4$High_low)

#Basal- subsetting by "temp" delivery
temp_deliv <- device_type(basal, 'Delivery_Type', "temp")

#September 4 Temp Basal Rates 
temp_Sept4 <- myday_month(4,"September", temp_deliv)

#Bolus
bolus_Sept4 <- myday_month(4,"September", bolus)
```


```{r}

```


```{r}
library(shiny)

ui <- fluidPage(
  
#Inputs 
selectInput(inputId= "input_month", label = "Select Month", choices = ("September"),multiple = FALSE),

numericInput(inputId = "input_day", value = 4, label = "Select Day ", min = 4, max = 31),

selectInput(inputId= "function_name", label = "Select Function", choices = c("temp_smbg", "high_smbg", "freq_smbg_5", "highBG_insulin", "bolus_high" , "low_smbg", "freq_smbgLow_5",
"lowBG_insulin", "bolus_low"),multiple = FALSE),

#Outputs
textOutput(outputId = "text")
#textOutput(outputId = "text3")
)

 
server <- function(input, output){
  
 #Subsetting data by specific day and month requested by the user 
   day_month <- reactive({
      new_subset <- subset(cgm, ((day(cgm$Local_Time) ==input$input_day &            months(cgm$Local_Time)==input$input_month)))
      new_subset$High_low <- NA
      new_subset$High_low[new_subset$Value >= 180] <- "High"
      new_subset$High_low[new_subset$Value <= 70] <- "Low"
      new_subset$High_low[new_subset$Value <= 180 & new_subset$Value >= 70] <- "Normal"
      new_subset$High_low <- as.factor(new_subset$High_low)
      if ((dim(new_subset)[1]) ==0){
          print("There is no data for this month and day.")
        }
        return (new_subset)
  }
)
   
 #Subsetting by day and month 
   day_and_month <- reactive({
  day_month()
 }
)
  #Adding a high/low column to distinguish level of CGM
  #  high_low_change <- reactive({
  #   high_low(day_month())
  #   }
  # )
#Basal- subsetting by "temp" delivery
  device_type_temp <- reactive({
    device_type(basal, 'Delivery_Type', "temp")
    }
  )
#Specific day/month "temp" Basal Rates 
  temp_rates <- reactive({myday_month(4,"September", device_type_temp())
  })
  
  #smbg data set 
  smbg_data <- reactive({myday_month(4,"September", smbg)
  })
  
 
  high_bg_subset<- reactive({
   subset(day_month(), (High_low == "High"))

 }
 )
  
   low_bg_subset<- reactive({
   subset(day_month(), (High_low == "Low"))

 }
 )
  
  bolus_data <- reactive({myday_month(4,"September", bolus)
  })


#Function will count the number of times user checked fingerstick within a certain amount of time after setting 'temp'
 temp_smbg <- reactive({
 count = 0
for (i in 1:nrow(day_and_month())){
 for (x in 1:nrow(temp_rates())){
if(day_and_month()$Local_Time[i] > temp_rates()$Local_Time[x]){
     if((day_and_month()$Local_Time[i]- temp_rates()$Local_Time[x]) < dminutes(60)){
       count = count + 1
        return(paste(day_and_month()$Local_Time[i] -(temp_rates()$Local_Time[x]),"Basal Temp setting time :\n", temp_rates()$Local_Time[x], "Fingerstick input Time: \n", day_and_month()$Local_Time[i], "Number of times user checked fingerstick within 60 min of setting of temp rate:\n " , count))
      
      }
   }
  }
  }
  }
 )
 
 high_smbg <- reactive({
if ((dim(high_bg_subset())[1]) ==0){
          return(print("There were no high glucose alerts for this day and month."))
        }
count = 0
for (i in 1:nrow(smbg_data())){
  for (x in 1:nrow(high_bg_subset())){
    if(smbg_data()$Local_Time[i] > high_bg_subset()$Local_Time[x]){
      if((smbg_data()$Local_Time[i]- high_bg_subset()$Local_Time[x]) < dminutes(30)){
        count = count + 1
        return(print(paste(smbg_data()$Local_Time[i] -(high_bg_subset()$Local_Time[x]),"High Glucose Alert Time:",high_bg_subset()$Local_Time[x],"\nFingerstick input Time:", smbg_data()$Local_Time[i])))
      
      }
    }
  }
}
 }
)
 
 freq_smbg_5 <- reactive({
count=0
for (i in 1:nrow(smbg_data())){
  for (x in 1:nrow(high_bg_subset())){
    if(smbg_data()$Local_Time[i] > high_bg_subset()$Local_Time[x]){
      if((smbg_data()$Local_Time[i]- high_bg_subset()$Local_Time[x]) < dminutes(5)){
        count = count + 1
        return(print(paste((smbg_data()$Local_Time[i] -(high_bg_subset()$Local_Time[x])), "Fingerstick input Time:",smbg_data()$Local_Time[i], "High Glucose Alert Time:", high_bg_subset()$Local_Time[x],
        "Frequency of BG Check entry within 5 min of high glucose alert: ",count)))
      }
    }
  }
}
 }
)
 
 highBG_insulin <- reactive({
count=0
for (i in 1:nrow(bolus_data())){
  for (x in 1:nrow(high_bg_subset())){
    if(bolus_data()$Local_Time[i] > high_bg_subset()$Local_Time[x]){
      if((bolus_data()$Local_Time[i]- high_bg_subset()$Local_Time[x]) < dminutes(60)){
        count = count + 1
        return(print(paste(bolus_data()$Local_Time[i] -(high_bg_subset()$Local_Time[x]), "High Glucose Alert Time:", high_bg_subset()$Local_Time[x], "Insulin Bolus Time:",bolus_data()$Local_Time[i])))
      
  
      }
    }
  }
}
 }
)
 
 bolus_high <- reactive({
count=0
for (i in 1:nrow(bolus_data())){
  for (x in 1:nrow(high_bg_subset())){
    if(bolus_data()$Local_Time[i] > high_bg_subset()$Local_Time[x]){
      if((bolus_data()$Local_Time[i]- high_bg_subset()$Local_Time[x]) < dminutes(1)){
        count = count + 1
        print(bolus_data()$Local_Time[i] -(high_bg_subset()$Local_Time[x]))
        print(paste("High Glucose Alert Time:", high_bg_subset()$Local_Time[x]))
        print(paste("Insulin Bolus Time:",bolus_data()$Local_Time[i]))
        print(" ")
      }

    }
  }
}
return(print(paste("Frequency of insulin bolus within *1 min* of high BG alert:", count)))
 }
)
 
 low_smbg <- reactive({
   count = 0
for (i in 1:nrow(smbg_data())){
  for (x in 1:nrow(low_bg_subset())){
    if(smbg_data()$Local_Time[i] > low_bg_subset()$Local_Time[x]){
      if((smbg_data()$Local_Time[i]- low_bg_subset()$Local_Time[x]) < dminutes(30)){
        count = count + 1
        return(print(paste(smbg_data()$Local_Time[i] -(low_bg_subset()$Local_Time[x]), "Low Glucose Alert Time:",low_bg_subset()$Local_Time[x],"Fingerstick input Time:", smbg_data()$Local_Time[i])))
      }
    }
  }
}
 }
)
 
 freq_smbgLow_5 <- reactive({
count=0
for (i in 1:nrow(smbg_data())){
  for (x in 1:nrow(low_bg_subset())){
    if(smbg_data()$Local_Time[i] > low_bg_subset()$Local_Time[x]){
      if((smbg_data()$Local_Time[i]- low_bg_subset()$Local_Time[x]) < dminutes(5)){
        count = count + 1
        print(smbg_data()$Local_Time[i] -(low_bg_subset()$Local_Time[x]))
        print(paste("Fingerstick input Time:",smbg_data()$Local_Time[i]))
        print(paste("Low Glucose Alert Time:", low_bg_subset()$Local_Time[x]))
      }
    }
  }
}
return(print(paste("Frequency of BG Check entry within *5 min* of Low glucose alert: ",count)))
}
)

 lowBG_insulin <- reactive({
count=0
for (i in 1:nrow(bolus_data())){
  for (x in 1:nrow(low_bg_subset())){
    if(bolus_data()$Local_Time[i] > low_bg_subset()$Local_Time[x]){
      if((bolus_data()$Local_Time[i]- low_bg_subset()$Local_Time[x]) < dminutes(60)){
        count = count + 1
        return(print(paste(bolus_data()$Local_Time[i] -(low_bg_subset()$Local_Time[x]),"Low Glucose Alert Time:", low_bg_subset()$Local_Time[x], "Insulin Bolus Time:",bolus_data()$Local_Time[i])))
      
      }
    }
  }
}
 }
)
 
 bolus_low <- reactive({
count=0
for (i in 1:nrow(bolus_data())){
  for (x in 1:nrow(low_bg_subset())){
    if(bolus_data()$Local_Time[i] > low_bg_subset()$Local_Time[x]){
      if((bolus_data()$Local_Time[i]- low_bg_subset()$Local_Time[x]) < dminutes(1)){
        count = count + 1
        print(bolus_data()$Local_Time[i] -(low_bg_subset()$Local_Time[x]))
        print(paste("Low Glucose Alert Time:", low_bg_subset()$Local_Time[x]))
        print(paste("Insulin Bolus Time:",bolus_data()$Local_Time[i]))
        print(" ")
      }

    }
  }
}
return(print(paste("Frequency of insulin bolus within *1 min* of Low BG alert:", count)))
}
)



 
 

  output$text <- renderText({
  
    if(input$function_name == "bolus_low"){
    bolus_low()
    }
    else if(input$function_name == "temp_smbg") {
      temp_smbg()
    }
    else if(input$function_name == "high_smbg") {
      high_smbg()
    }
    else if(input$function_name == "freq_smbg_5"){
      freq_smbg_5()
    } 
    else if(input$function_name == " highBG_insulin"){
       highBG_insulin()
    } 
    else if(input$function_name == "bolus_high"){
      bolus_high()
    } 
    else if(input$function_name == "freq_smbgLow_5"){
      freq_smbgLow_5()
    } 
    else if(input$function_name == "lowBG_insulin"){
      lowBG_insulin()
    } 
    else if(input$function_name == "low_smbg"){
      low_smbg()
    } 
    
     
    
  }
  )
}


shinyApp(ui = ui, server = server)


```



